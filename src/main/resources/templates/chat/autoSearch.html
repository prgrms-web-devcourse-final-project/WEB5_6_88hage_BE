<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ëª¨ì„ ê²€ìƒ‰ ìë™ì™„ì„± í…ŒìŠ¤íŠ¸</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 40px 20px;
    }

    .container {
      max-width: 600px;
      margin: 0 auto;
      background: white;
      border-radius: 20px;
      box-shadow: 0 20px 40px rgba(0,0,0,0.15);
      overflow: hidden;
    }

    .header {
      background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
      padding: 40px;
      text-align: center;
      color: white;
    }

    .header h1 {
      font-size: 2.2em;
      margin-bottom: 10px;
      font-weight: 700;
    }

    .header p {
      font-size: 1.1em;
      opacity: 0.9;
    }

    .search-section {
      padding: 40px;
    }

    .search-container {
      position: relative;
      margin-bottom: 30px;
    }

    .search-input {
      width: 100%;
      padding: 20px 60px 20px 25px;
      border: 3px solid #e8ecf4;
      border-radius: 15px;
      font-size: 18px;
      transition: all 0.3s ease;
      outline: none;
      background: #f8f9ff;
    }

    .search-input:focus {
      border-color: #4facfe;
      box-shadow: 0 0 25px rgba(79, 172, 254, 0.4);
      background: white;
    }

    .search-icon {
      position: absolute;
      right: 20px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 24px;
      color: #666;
    }

    .autocomplete-dropdown {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: white;
      border: 2px solid #e8ecf4;
      border-radius: 15px;
      box-shadow: 0 15px 35px rgba(0,0,0,0.15);
      z-index: 1000;
      max-height: 350px;
      overflow-y: auto;
      margin-top: 8px;
      display: none;
    }

    .autocomplete-item {
      padding: 18px 25px;
      cursor: pointer;
      border-bottom: 1px solid #f5f6fa;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      font-size: 16px;
    }

    .autocomplete-item:hover {
      background: linear-gradient(135deg, #f8f9ff 0%, #e8f4ff 100%);
      color: #4facfe;
      transform: translateX(5px);
    }

    .autocomplete-item:last-child {
      border-bottom: none;
    }

    .autocomplete-icon {
      margin-right: 15px;
      font-size: 20px;
      width: 25px;
      text-align: center;
    }

    .autocomplete-text {
      flex: 1;
    }

    .autocomplete-type {
      font-size: 12px;
      color: #888;
      background: #f0f2f5;
      padding: 4px 8px;
      border-radius: 8px;
      text-transform: uppercase;
      font-weight: 600;
    }

    .api-info {
      background: #f8f9ff;
      border: 2px solid #e8f4ff;
      border-radius: 15px;
      padding: 25px;
      margin-top: 30px;
    }

    .api-title {
      font-size: 1.3em;
      font-weight: 600;
      color: #333;
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .api-url {
      background: #2d3748;
      color: #68d391;
      padding: 15px 20px;
      border-radius: 10px;
      font-family: 'Consolas', 'Monaco', monospace;
      font-size: 14px;
      margin-bottom: 15px;
      word-break: break-all;
    }

    .api-params {
      font-size: 14px;
      color: #666;
      line-height: 1.6;
    }

    .test-status {
      margin-top: 20px;
      padding: 15px 20px;
      border-radius: 10px;
      font-weight: 600;
      text-align: center;
    }

    .status-success {
      background: #d4edda;
      color: #155724;
      border: 2px solid #c3e6cb;
    }

    .status-loading {
      background: #fff3cd;
      color: #856404;
      border: 2px solid #ffeaa7;
    }

    .status-error {
      background: #f8d7da;
      color: #721c24;
      border: 2px solid #f5c6cb;
    }

    .no-results {
      padding: 20px;
      text-align: center;
      color: #888;
      font-style: italic;
    }

    @media (max-width: 768px) {
      .container {
        margin: 0 10px;
      }

      .header {
        padding: 30px 20px;
      }

      .header h1 {
        font-size: 1.8em;
      }

      .search-section {
        padding: 30px 20px;
      }

      .search-input {
        padding: 18px 50px 18px 20px;
        font-size: 16px;
      }
    }
  </style>
</head>
<body>
<div class="container">
  <div class="header">
    <h1>ğŸ” ìë™ì™„ì„± í…ŒìŠ¤íŠ¸</h1>
    <p>ëª¨ì„ ê²€ìƒ‰ ìë™ì™„ì„± API í…ŒìŠ¤íŠ¸ í˜ì´ì§€</p>
  </div>

  <div class="search-section">
    <div class="search-container">
      <input
          type="text"
          class="search-input"
          placeholder="ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”... (ì˜ˆ: ì¶•êµ¬, ë…ì„œ, ìš”ë¦¬)"
          id="searchInput"
          th:value="${keyword ?: ''}"
      >
      <span class="search-icon">ğŸ”</span>

      <div class="autocomplete-dropdown" id="autocompleteDropdown">
        <!-- ìë™ì™„ì„± ê²°ê³¼ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
      </div>
    </div>

    <div class="api-info">
      <div class="api-title">
        âš¡ API ì—”ë“œí¬ì¸íŠ¸
      </div>
      <div class="api-url" th:text="'GET ' + ${@environment.getProperty('server.servlet.context-path', '')} + '/api/groups/autocomplete?keyword={keyword}'">
        GET /api/groups/autocomplete?keyword={keyword}
      </div>
      <div class="api-params">
        <strong>íŒŒë¼ë¯¸í„°:</strong><br>
        â€¢ keyword: ê²€ìƒ‰í•  í‚¤ì›Œë“œ (ìµœì†Œ 1ê¸€ì)<br>
        <span th:if="${#strings.isEmpty(keyword)}" style="color: #999;">
          â€¢ í˜„ì¬ í‚¤ì›Œë“œ: ì—†ìŒ
        </span>
        <span th:unless="${#strings.isEmpty(keyword)}" style="color: #4facfe;">
          â€¢ í˜„ì¬ í‚¤ì›Œë“œ: <strong th:text="${keyword}"></strong>
        </span>
      </div>

      <div id="testStatus" class="test-status status-loading" style="display: none;">
        API í˜¸ì¶œ ì¤‘...
      </div>
    </div>
  </div>
</div>

<!-- Thymeleafì—ì„œ JavaScript ë³€ìˆ˜ ì „ë‹¬ -->
<script th:inline="javascript">
  /*<![CDATA[*/
  const API_BASE_URL = /*[[${@environment.getProperty('server.servlet.context-path', '')}]]*/ '';
  const CSRF_TOKEN = /*[[${_csrf?.token}]]*/ null;
  const CSRF_HEADER = /*[[${_csrf?.headerName}]]*/ null;
  /*]]>*/
</script>

<script>
  const searchInput = document.getElementById('searchInput');
  const autocompleteDropdown = document.getElementById('autocompleteDropdown');
  const testStatus = document.getElementById('testStatus');

  let searchTimeout;

  // CSRF í† í° í—¤ë” ì„¤ì •
  function getHeaders() {
    const headers = {
      'Content-Type': 'application/json'
    };

    if (CSRF_TOKEN && CSRF_HEADER) {
      headers[CSRF_HEADER] = CSRF_TOKEN;
    }

    return headers;
  }

  // ìë™ì™„ì„± API í˜¸ì¶œ
  async function callAutocompleteAPI(keyword) {
    try {
      const url = `${API_BASE_URL}/api/groups/autocomplete?keyword=${encodeURIComponent(keyword)}`;

      const response = await fetch(url, {
        method: 'GET',
        headers: getHeaders()
      });

      if (!response.ok) {
        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
      }

      const data = await response.json();
      return data;

    } catch (error) {
      console.error('API Error:', error);

      // ê°œë°œ í™˜ê²½ì—ì„œëŠ” ëª¨ì˜ ë°ì´í„° ë°˜í™˜
      if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
        console.warn('Using mock data for development');
        return getMockData(keyword);
      }

      throw error;
    }
  }

  // ëª¨ì˜ ë°ì´í„° (ê°œë°œìš©)
  function getMockData(keyword) {
    const mockData = [
      { text: "ì¶•êµ¬", type: "keyword", icon: "âš½" },
      { text: "ì¶•êµ¬ëª¨ì„", type: "title", icon: "ğŸ“‹" },
      { text: "ë…ì„œ", type: "keyword", icon: "ğŸ“š" },
      { text: "ë…ì„œí´ëŸ½", type: "title", icon: "ğŸ“‹" },
      { text: "ìš”ë¦¬", type: "keyword", icon: "ğŸ‘¨â€ğŸ³" },
      { text: "ìš”ë¦¬êµì‹¤", type: "title", icon: "ğŸ“‹" },
      { text: "ì˜í™”", type: "keyword", icon: "ğŸ¬" },
      { text: "ì˜í™”ê°ìƒ", type: "title", icon: "ğŸ“‹" },
      { text: "ë“±ì‚°", type: "keyword", icon: "ğŸ”ï¸" },
      { text: "ë“±ì‚°ë™í˜¸íšŒ", type: "title", icon: "ğŸ“‹" },
      { text: "ìŠ¤í„°ë””", type: "hashtag", icon: "#" },
      { text: "ì¹œëª©", type: "hashtag", icon: "#" },
      { text: "ì£¼ë§", type: "hashtag", icon: "#" },
      { text: "ê°•ë‚¨", type: "hashtag", icon: "#" },
      { text: "í™ëŒ€", type: "hashtag", icon: "#" }
    ];

    return mockData.filter(item =>
        item.text.toLowerCase().includes(keyword.toLowerCase())
    ).slice(0, 8);
  }

  // ìë™ì™„ì„± ê²°ê³¼ í‘œì‹œ
  function showAutocomplete(suggestions) {
    if (!Array.isArray(suggestions) || suggestions.length === 0) {
      autocompleteDropdown.innerHTML = '<div class="no-results">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤</div>';
      autocompleteDropdown.style.display = 'block';
      return;
    }

    autocompleteDropdown.innerHTML = suggestions.map(item => `
      <div class="autocomplete-item" onclick="selectAutocomplete('${escapeHtml(item.text)}')">
        <span class="autocomplete-icon">${escapeHtml(item.icon || 'ğŸ“‹')}</span>
        <span class="autocomplete-text">${escapeHtml(item.text)}</span>
        <span class="autocomplete-type">${escapeHtml(item.type || 'unknown')}</span>
      </div>
    `).join('');

    autocompleteDropdown.style.display = 'block';
  }

  // HTML ì´ìŠ¤ì¼€ì´í”„ í•¨ìˆ˜
  function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  // ìë™ì™„ì„± í•­ëª© ì„ íƒ
  function selectAutocomplete(text) {
    searchInput.value = text;
    autocompleteDropdown.style.display = 'none';

    testStatus.className = 'test-status status-success';
    testStatus.textContent = `âœ… "${text}" ì„ íƒë¨`;
    testStatus.style.display = 'block';

    // ì„ íƒëœ ê°’ìœ¼ë¡œ í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨ (ì„ íƒì‚¬í•­)
    // window.location.href = `${window.location.pathname}?keyword=${encodeURIComponent(text)}`;
  }

  // ê²€ìƒ‰ ì…ë ¥ ì´ë²¤íŠ¸
  searchInput.addEventListener('input', function(e) {
    const keyword = e.target.value.trim();

    clearTimeout(searchTimeout);

    if (keyword.length >= 1) {
      // ìƒíƒœ í‘œì‹œ
      testStatus.className = 'test-status status-loading';
      testStatus.textContent = `ğŸ”„ "${keyword}" ê²€ìƒ‰ ì¤‘...`;
      testStatus.style.display = 'block';

      // 300ms ì§€ì—° í›„ API í˜¸ì¶œ
      searchTimeout = setTimeout(async () => {
        try {
          const suggestions = await callAutocompleteAPI(keyword);
          showAutocomplete(suggestions);

          // ì„±ê³µ ìƒíƒœ í‘œì‹œ
          testStatus.className = 'test-status status-success';
          testStatus.textContent = `âœ… ${suggestions.length}ê°œ ê²°ê³¼ ì°¾ìŒ`;

        } catch (error) {
          // ì—ëŸ¬ ìƒíƒœ í‘œì‹œ
          testStatus.className = 'test-status status-error';
          testStatus.textContent = `âŒ API í˜¸ì¶œ ì‹¤íŒ¨: ${error.message}`;
          autocompleteDropdown.style.display = 'none';
        }
      }, 300);

    } else {
      autocompleteDropdown.style.display = 'none';
      testStatus.style.display = 'none';
    }
  });

  // ì™¸ë¶€ í´ë¦­ ì‹œ ìë™ì™„ì„± ìˆ¨ê¸°ê¸°
  document.addEventListener('click', function(e) {
    if (!e.target.closest('.search-container')) {
      autocompleteDropdown.style.display = 'none';
    }
  });

  // í‚¤ë³´ë“œ ë„¤ë¹„ê²Œì´ì…˜
  let selectedIndex = -1;
  searchInput.addEventListener('keydown', function(e) {
    const items = autocompleteDropdown.querySelectorAll('.autocomplete-item');

    if (e.key === 'ArrowDown') {
      e.preventDefault();
      selectedIndex = Math.min(selectedIndex + 1, items.length - 1);
      updateSelection(items);
    } else if (e.key === 'ArrowUp') {
      e.preventDefault();
      selectedIndex = Math.max(selectedIndex - 1, -1);
      updateSelection(items);
    } else if (e.key === 'Enter') {
      e.preventDefault();
      if (selectedIndex >= 0 && items[selectedIndex]) {
        items[selectedIndex].click();
      }
    } else if (e.key === 'Escape') {
      autocompleteDropdown.style.display = 'none';
      selectedIndex = -1;
    }
  });

  function updateSelection(items) {
    items.forEach((item, index) => {
      if (index === selectedIndex) {
        item.style.background = 'linear-gradient(135deg, #f8f9ff 0%, #e8f4ff 100%)';
        item.style.color = '#4facfe';
      } else {
        item.style.background = '';
        item.style.color = '';
      }
    });
  }

  // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
  document.addEventListener('DOMContentLoaded', function() {
    // URL íŒŒë¼ë¯¸í„°ì—ì„œ í‚¤ì›Œë“œê°€ ìˆìœ¼ë©´ ìë™ ê²€ìƒ‰
    const urlParams = new URLSearchParams(window.location.search);
    const initialKeyword = urlParams.get('keyword');

    if (initialKeyword && searchInput.value === initialKeyword) {
      // ì´ˆê¸° í‚¤ì›Œë“œë¡œ ìë™ì™„ì„± í…ŒìŠ¤íŠ¸
      setTimeout(() => {
        const event = new Event('input', { bubbles: true });
        searchInput.dispatchEvent(event);
      }, 500);
    }
  });
</script>
</body>
</html>